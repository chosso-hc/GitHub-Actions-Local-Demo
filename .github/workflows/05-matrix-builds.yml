name: 05 - Matrix Builds

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # Matrix Build: Testet gegen mehrere Java-Versionen parallel
  test-matrix:
    runs-on: ubuntu-latest
    strategy:
      # fail-fast: bei 'false' laufen alle Matrix-Jobs weiter, auch wenn einer fehlschlägt
      fail-fast: false
      # max-parallel: 1 führt Jobs sequentiell aus, für parallele Ausführung auskommentieren oder auf höheren Wert setzen
      max-parallel: 1
      matrix:
        # Definiert die Matrix-Dimensionen
        test-type: ['unit', 'package']
    
    # Job-Name wird dynamisch mit Matrix-Werten erstellt
    name: Test - ${{ matrix.test-type }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: backend/pom.xml

      - name: Run ${{ matrix.test-type }} Tests
        working-directory: ./backend
        run: |
          echo "Running ${{ matrix.test-type }} tests"
          if [ "${{ matrix.test-type }}" = "unit" ]; then
            mvn test
          else
            mvn package
          fi

  # Matrix Build: Baut Docker-Images mit verschiedenen Tags
  docker-matrix:
    needs: test-matrix
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        tag: ['latest', 'dev']
    
    name: Docker Build - ${{ matrix.tag }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: backend/pom.xml

      - name: Build JAR
        working-directory: ./backend
        run: mvn package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker Layer Cache
      - name: Cache Docker Layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-buildx-${{ matrix.tag }}-${{ hashFiles('backend/Dockerfile', 'backend/pom.xml') }}
          restore-keys: |
            docker-buildx-${{ matrix.tag }}-
            docker-buildx-

      - name: Build Docker Image with tag ${{ matrix.tag }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          load: true
          tags: demo-app:${{ matrix.tag }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # Cache Move (verhindert unbegrenztes Wachstum)
      - name: Move Cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # Kombinierte Matrix: include für spezifische Kombinationen
  integration-test-matrix:
    needs: test-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        # Kombiniert Test-Typ mit spezifischen Commands
        include:
          - test-type: 'unit'
            test-command: 'mvn test'
            description: 'Unit Tests'
          - test-type: 'integration'
            test-command: 'mvn verify'
            description: 'Integration Tests'
          - test-type: 'compile-only'
            test-command: 'mvn compile'
            description: 'Compile Check'
    
    name: ${{ matrix.description }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: backend/pom.xml

      - name: Run ${{ matrix.test-type }} Tests
        working-directory: ./backend
        run: ${{ matrix.test-command }}

  # Zusammenfassung: Läuft immer und zeigt Ergebnisse aller Matrix-Jobs
  matrix-summary:
    if: always()
    needs: [test-matrix, docker-matrix, integration-test-matrix]
    runs-on: ubuntu-latest
    steps:
      - name: Matrix Build Summary
        run: |
          echo "================================"
          echo "Matrix Build Zusammenfassung"
          echo ""
          echo "Job-Status:"
          echo "- test-matrix: ${{ needs.test-matrix.result }}"
          echo "- docker-matrix: ${{ needs.docker-matrix.result }}"
          echo "- integration-test-matrix: ${{ needs.integration-test-matrix.result }}"
          echo ""
          echo "Getestete Konfigurationen:"
          echo "- Test-Typen: unit, package"
          echo "- Docker Tags: latest, dev"
          echo "- Integration Tests: unit, integration, compile-only"
          echo ""
          echo "Gesamtanzahl paralleler Jobs: 7"
          echo ""
